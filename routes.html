<!doctype html>
<html lang="az">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mar≈ürut Planlayƒ±cƒ± ‚Äî UrbanFlow (Integrated)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: Inter, system-ui, Arial, sans-serif;
      margin: 0;
      background: #3ca5d7;
      color: #1f2937;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 18px;
      background: #linear-gradient(90deg, #08306b, #0b3d91);
      box-shadow: 0 2px 8px rgba(16, 24, 40, .04);
    }

    .brand {
      font-weight: 700;
      color: #0f172a;
    }

    .controls a {
      color: #ff0000;
      text-decoration: none;
      margin-left: 8px;
    }

    .container {
      display: flex;
      gap: 16px;
      padding: 18px;
      max-width: 1200px;
      margin: 18px auto;
      box-sizing: border-box;
    }

    .routes-container {
      flex-direction: row;
      align-items: flex-start;
    }

    .panel {
      background: #fff;
      padding: 14px;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(2, 6, 23, .04);
    }

    .route-inputs {
      width: 360px;
    }

    label {
      display: block;
      margin: 8px 0;
      font-size: 14px;
      color: #374151;
    }

    input,
    select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #e6edf3;
      border-radius: 6px;
      margin-top: 6px;
    }

    button {
      padding: 10px 14px;
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    #routeMap {
      width: 760px;
      border-radius: 8px;
      overflow: hidden;
    }

    #route-info {
      margin-top: 12px;
      font-size: 15px;
    }

    .muted {
      color: #6b7280;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand" onclick="window.location.href='index.html'">UrbanFlow</div>
    <div class="controls">
      <a href="index.html">Ana Panel</a>
    </div>
  </header>

  <main class="container routes-container">
    <section class="panel route-inputs">
      <h2>Mar≈ürut tap</h2>
      <label>Ba≈ülanƒüƒ±c:
        <input id="start" placeholder="N√ºmun…ô: Nizami k√º√ß…ôsi, Bakƒ± v…ô ya 40.384,49.834" />
      </label>
      <label>Son:
        <input id="end" placeholder="N√ºmun…ô: Bin…ôq…ôdi q…ôs…ôb…ôsi v…ô ya 40.409,49.867" />
      </label>
      <label>Prioritet:
        <select id="route-priority">
          <option value="fastest">∆èn s√ºr…ôtli</option>
          <option value="shortest">∆èn qƒ±sa</option>
          <option value="recommended">T√∂vsiy…ô edil…ôn</option>
        </select>
      </label>
      <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
        <button id="find-route">Yol tap</button>
        <button id="btn-enable-push" style="background:#06b6d4">üîî Bildiri≈ü</button>
      </div>
      <div id="route-info" style="margin-top:10px;font-weight:600;"></div>
      <div class="muted" style="margin-top:8px">ƒ∞pucu: √únvan v…ô ya koordinat yaza bil…ôrsiniz (m…ôs. ‚ÄúNizami k√º√ß…ôsi, Bakƒ±‚Äù).</div>
    </section>

    <section class="panel route-map">
      <div id="routeMap" style="height:600px"></div>
    </section>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    function initSmallMap(containerId = 'routeMap') {
      if (window.mainMap) return window.mainMap;
      const map = L.map(containerId).setView([40.4093, 49.8671], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      window.mainMap = map;
      return map;
    }
  </script>

  <script>
    const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImJjNWE3YmE3MTM0YzQ1NjdiNTFjYjRiYWQxZjUzMjMwIiwiaCI6Im11cm11cjY0In0=";

    function haversineKm(a, b) {
      const R = 6371;
      const toRad = Math.PI / 180;
      const dLat = (b[0] - a[0]) * toRad;
      const dLon = (b[1] - a[1]) * toRad;
      const la = a[0] * toRad, lb = b[0] * toRad;
      const aa = Math.sin(dLat / 2) ** 2 + Math.cos(la) * Math.cos(lb) * Math.sin(dLon / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(aa), Math.sqrt(1 - aa));
    }

    function decodePolyline(str, precision = 5) {
      if (!str) return [];
      if (Array.isArray(str)) return str.map(c => [c[1], c[0]]);
      let index = 0, lat = 0, lng = 0, coordinates = [];
      const factor = Math.pow(10, precision);
      while (index < str.length) {
        let b, shift = 0, result = 0;
        do { b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
        let deltaLat = (result & 1) ? ~(result >> 1) : (result >> 1);
        lat += deltaLat;
        shift = 0; result = 0;
        do { b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
        let deltaLng = (result & 1) ? ~(result >> 1) : (result >> 1);
        lng += deltaLng;
        coordinates.push([lat / factor, lng / factor]);
      }
      return coordinates;
    }

    async function findOptimalRoute(startLatLng, endLatLng, options = {}, map = null) {
      if (ORS_API_KEY && ORS_API_KEY.length > 10) {
        try {
          const profile = options.profile || "driving-car";
          const preference = (options.priority === 'shortest') ? 'shortest' : (options.priority === 'recommended' ? 'recommended' : 'fastest');
          const body = { coordinates: [[startLatLng[1], startLatLng[0]], [endLatLng[1], endLatLng[0]]], preference, instructions: true };
          const resp = await fetch(`https://api.openrouteservice.org/v2/directions/${profile}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': ORS_API_KEY },
            body: JSON.stringify(body)
          });
          const data = await resp.json();
          const rt = data.routes && data.routes[0];
          const geom = rt.geometry;
          const path = Array.isArray(geom) ? decodePolyline(geom) : (rt.geometry && decodePolyline(rt.geometry) || []);
          const distanceKm = (rt.summary && rt.summary.distance ? rt.summary.distance / 1000 : haversineKm(startLatLng, endLatLng));
          const durationMin = (rt.summary && rt.summary.duration ? rt.summary.duration / 60 : (distanceKm / 40) * 60);
          if (map) {
            if (map._routeLayer) map.removeLayer(map._routeLayer);
            map._routeLayer = L.polyline(path, { color: '#ff6b6b', weight: 6, opacity: 0.9 }).addTo(map);
            map.fitBounds(map._routeLayer.getBounds(), { padding: [20, 20] });
          }
          return { path, distance: distanceKm, time: durationMin, raw: data };
        } catch (err) {
          console.warn('ORS call failed', err);
        }
      }
      const distanceKm = haversineKm(startLatLng, endLatLng);
      const avgSpeed = (options.priority === 'shortest') ? 50 : 40;
      const durationMin = (distanceKm / avgSpeed) * 60;
      const path = [startLatLng, [(startLatLng[0] + endLatLng[0]) / 2, (startLatLng[1] + endLatLng[1]) / 2], endLatLng];
      if (map) {
        if (map._routeLayer) map.removeLayer(map._routeLayer);
        map._routeLayer = L.polyline(path, { color: '#ff6b6b', weight: 6, opacity: 0.9 }).addTo(map);
        map.fitBounds(map._routeLayer.getBounds(), { padding: [20, 20] });
      }
      return { path, distance: distanceKm, time: durationMin, raw: null };
    }
  </script>

  <script>
    async function geocodeAddress(query) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
      try {
        const res = await fetch(url, { headers: { 'Accept-Language': 'az' } });
        const data = await res.json();
        if (data && data[0]) return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      } catch (err) { console.warn('Geocoding error', err); }
      return null;
    }

    function speakText(text) {
      if (!('speechSynthesis' in window)) return;
      try {
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'az-AZ';
        utter.rate = 0.95;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utter);
      } catch (e) { console.warn('TTS error', e); }
    }

    document.getElementById('find-route').addEventListener('click', async () => {
      const s = document.getElementById('start').value.trim();
      const e = document.getElementById('end').value.trim();
      const p = document.getElementById('route-priority').value;
      if (!s || !e) return alert('Ba≈ülanƒüƒ±c v…ô son n√∂qt…ôl…ôri daxil edin.');

      const map = initSmallMap('routeMap');
      const infoEl = document.getElementById('route-info');
      infoEl.innerText = 'Mar≈ürut hesablanƒ±r...';

      let sLatLng, eLatLng;
      const coordRegex = /^-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?$/;

      if (coordRegex.test(s)) sLatLng = s.split(',').map(x => parseFloat(x.trim()));
      else sLatLng = await geocodeAddress(s);

      if (coordRegex.test(e)) eLatLng = e.split(',').map(x => parseFloat(x.trim()));
      else eLatLng = await geocodeAddress(e);

      if (!sLatLng || !eLatLng) return alert('√únvanlardan biri tapƒ±lmadƒ±.');

      L.marker(sLatLng).addTo(map).bindPopup("Ba≈ülanƒüƒ±c").openPopup();
      L.marker(eLatLng).addTo(map).bindPopup("Son");

      const route = await findOptimalRoute(sLatLng, eLatLng, { priority: p }, map);
      if (route) {
        const distance = route.distance || 0;
        const time = route.time || 0;
        const avgConsumption = 7;
        const emissionPerL = 2.31;
        const fuel = (distance / 100) * avgConsumption;
        const co2 = fuel * emissionPerL;

        infoEl.innerHTML = `
üöó M…ôsaf…ô: <b>${distance.toFixed(1)} km</b><br/>
‚è± Vaxt: <b>${time.toFixed(0)} d…ôq</b><br/>
‚õΩ Yanacaq: <b>${fuel.toFixed(1)} L</b><br/>
üåç CO‚ÇÇ emissiyasƒ±: <b>${co2.toFixed(1)} kg</b>
        `;
        speakText(`Mar≈ürut tapƒ±ldƒ±. M…ôsaf…ô ${distance.toFixed(1)} kilometr, t…ôxmin…ôn ${time.toFixed(0)} d…ôqiq…ô.`);
      } else infoEl.innerText = '‚ùå Mar≈ürut tapƒ±lmadƒ±.';
    });
  </script>

</body>
</html>


